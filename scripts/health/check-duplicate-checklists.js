#!/usr/bin/env node
const fs = require('fs'), path = require('path');
const roots = ['src','docs','content'].filter(fs.existsSync);
const keywords = /(checklist|sjekkliste|maintenance|vedlikehold|oppgaver|tasks)/i;
let offenders=[];

function walk(d){
  for(const n of fs.readdirSync(d)){
    const p=path.join(d,n),s=fs.statSync(p);
    if(s.isDirectory()) {
      walk(p); 
    } else if(/\.(md|mdx|json|ts|tsx|yaml|yml)$/i.test(n)){
      const t=fs.readFileSync(p,'utf8'); 
      const banner=/AUTOGENERATED:\s*Source=maintenance_tasks/i.test(t);
      if(keywords.test(t)&&!banner){
        const looks=/(^|\n)[-*+\d]+\s+\S+/.test(t)||/"tasks"\s*:\s*\[/.test(t); 
        if(looks) offenders.push(p);
      }
    }
  }
}

roots.forEach(walk);
if(offenders.length){
  console.error('Duplicate/manual checklists without AUTOGENERATED banner:\n'+offenders.map(x=>' - '+x).join('\n'));
  process.exit(1);
}
console.log('OK: No duplicate/manual checklists.');